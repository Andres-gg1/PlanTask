{% extends "layout.jinja2" %}

{% block title %}Chats{% endblock %}

{% block styles %}
<link href="{{ request.static_url('plantask:static/styles/chats.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="main-layout">
  <main class="mycontainer" style="display: flex;">
    <aside class="left-sidebar">
      <h1 style="margin-bottom: 1rem;">My Chats</h1> 
      <div class="search-container">
        <input type="text" id="chats-search" class="chats-search" placeholder="Filter by name">
        <i class="bi-search search-icon"></i>
      </div>
      <div class="chats-scroll-area">
        {% if chats %}
        <ul class="list-group mb-4" id="chats-list">
          {% for f in chats %}
            <li class="list-group-item justify-content-between align-items-center chat-item" 
                data-chat-id="{{ f.chat_id }}" 
                data-first-name="{{ f.first_name | lower }}" 
                data-last-name="{{ f.last_name | lower }}" 
                data-username="{{ f.username | lower }}"
                data-image-route="{{ f.image_route if f.image_route else '' }}">
              <div style="cursor:pointer; display: flex; align-items: center;">
                {% if f.image_route %}
                  <img src="{{ f.image_route }}" 
                  style="width: 2.5rem; height: 2.5rem; border-radius: 50%; object-fit: cover; display: inline-block; margin-right: 1rem;">
                {% else %}
                  <img src="{{ request.static_url('plantask:static/default_pfp.svg') }}" 
                  style="width: 2.5rem; height: 2.5rem; border-radius: 50%; object-fit: cover; display: inline-block; margin-right: 1rem;">
                {% endif %}
                <div style="display: flex; flex-direction: column;">
                  <span style="font-weight: bold; margin-right: 1rem;">{{ f.first_name }} {{ f.last_name }}</span>
                  <span class="text-muted">@{{ f.username }}</span>
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
        {% else %}
          <p>No chats available</p>
        {% endif %}
      </div>
    </aside>
    <section class="chat-messages" style="flex: 1 1 0; min-width: 0; display: flex; flex-direction: column;">
      <div class="ChatInfo" style="display: none; align-items: center;">
      <img class="chatinfo-pfp" 
          src="{{ request.static_url('plantask:static/default_pfp.svg') }}" 
          alt="Profile Picture" 
          style="width: 3rem; height: 3rem; border-radius: 50%; object-fit: cover; margin-right: 1rem;">
      <div style="display: flex; flex-direction: column;">
        <h4 style="margin: 0; font-weight: bold;">Full Name</h4>
        <small class="text-muted">@username</small>
      </div>
      <i class="bi-three-dots-vertical fs-1" style="margin-left: auto; margin-right: 0.5rem;"></i>
    </div>
      <div class="messages">
        <p class="empty-message-hint" style="text-align:center; color:#aaa;">Select a chat to view messages</p>
      </div>
      <button id="scroll-to-bottom-btn" class="scroll-to-bottom-btn">
        Scroll to bottom <i class="bi-arrow-down"></i>
      </button>
      <form id="message-form" method="post" action="/send-message" style="display: none;">
        <div class="chat-input-bar">
          <input type="hidden" name="chat_id" id="chat-id-field">
          <input type="hidden" name="is_personal_chat" id="is-personal-chat-field">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <i class="bi-person-circle user-icon"></i>
          <input type="text" id="message-input" name="message-input" class="chat-input" placeholder="Write a message" />
          <i class="bi-paperclip attach-icon"></i>
          <button class="send-button">
            Send <i class="bi-send"></i>
          </button>
        </div>
      </form>
    </section>
  </main>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ request.static_url('plantask:static/scripts/chats.js') }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const userId = {{ request.session.user_id }};
    const chatItems = document.querySelectorAll('.chat-item');
    const messagesContainer = document.querySelector('.messages');
    const chatInfo = document.querySelector('.ChatInfo h4');
    const chatIdField = document.getElementById('chat-id-field');
    const isPersonalField = document.getElementById('is-personal-chat-field');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const scrollBtn = document.getElementById('scroll-to-bottom-btn');
    let currentChatId = null;

    function scrollToBottom() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

    }

    function handleScrollButtonVisibility() {
      const threshold = 100;
      const atBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < threshold;
      scrollBtn.style.display = atBottom ? 'none' : 'block';
    }

    scrollBtn.addEventListener('click', scrollToBottom);
    messagesContainer.addEventListener('scroll', handleScrollButtonVisibility);

    function renderMessages(messages) {
      const chatInfoBlock = document.querySelector('.ChatInfo');
      const inputForm = document.getElementById('message-form');

      chatInfoBlock.style.display = 'flex';
      inputForm.style.display = 'block';
      messagesContainer.innerHTML = '';

      if (messages.length === 0) {
        messagesContainer.innerHTML = '<p style="text-align:center; color:#aaa;">No messages yet</p>';
        return;
      }

      messages.forEach(msg => {
        const isMine = msg.sender_id === userId;
        const messageDiv = document.createElement('div');
        messageDiv.className = isMine ? 'mymessage' : 'amessage';

        messageDiv.innerHTML = `
          <p class="message-info">${new Date(msg.date_sent).toLocaleString()}</p>
          <p class="${isMine ? 'mymessagebubble' : 'amessagebubble'}">
            ${msg.message_cont}
          </p>
          ${isMine ? `<i class="bi ${msg.state === 'read' ? 'bi-check2-all' : 'bi-check2'}"></i>` : ''}
        `;
        messagesContainer.appendChild(messageDiv);
      });

      // Auto-scroll if near bottom
      const nearBottom = messagesContainer.scrollTop >= messagesContainer.scrollHeight - messagesContainer.clientHeight - 100;
      if (nearBottom) {
        scrollToBottom();
      }
      handleScrollButtonVisibility();
    }

    async function fetchAndRenderMessages(chatId) {
      try {
        const response = await fetch(`/get-personal-chat-messages/${chatId}`);
        const data = await response.json();
        renderMessages(data.messages || []);
      } catch (error) {
        console.error('Fetch error:', error);
      }
    }

    chatItems.forEach(item => {
      item.addEventListener('click', async () => {
        chatItems.forEach(chat => chat.classList.remove('active'));
        item.classList.add('active');

        const chatId = item.dataset.chatId;
        const firstName = item.dataset.firstName;
        const lastName = item.dataset.lastName;
        const username = item.dataset.username;
        const imageRoute = item.dataset.imageRoute;

        const chatInfo = document.querySelector('.ChatInfo');
        const pfpImg = chatInfo.querySelector('.chatinfo-pfp');
        const fullNameElem = chatInfo.querySelector('h4');
        const usernameElem = chatInfo.querySelector('small');

        pfpImg.src = imageRoute || "{{ request.static_url('plantask:static/default_pfp.svg') }}";
        const cap = s => s.charAt(0).toUpperCase() + s.slice(1);
        fullNameElem.textContent = `${cap(firstName)} ${cap(lastName)}`;
        usernameElem.textContent = `@${username}`;

        currentChatId = chatId;
        chatIdField.value = chatId;
        isPersonalField.value = 'true';

        await fetchAndRenderMessages(chatId);
      });
    });

    setInterval(() => {
      if (!currentChatId) return;
      const distanceFromBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight;
      const isNearBottom = distanceFromBottom < 100;
      if (isNearBottom) {
        fetchAndRenderMessages(currentChatId);
      }
    }, 3000);

    messageForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const chatId = chatIdField.value;
      const messageContent = messageInput.value.trim();
      if (!messageContent) return;

      try {
        const formData = new FormData(messageForm);
        const response = await fetch('/send-message', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        if (result.success) {
          messageInput.value = '';
          await fetchAndRenderMessages(chatId);
        } else {
          console.error('Send error:', result.error_ping || 'Unknown error');
        }
      } catch (err) {
        console.error('Send failed:', err);
      }
    });
  });
</script>
{% endblock %}